<!DOCTYPE html>
<html>
<head>
  <title>Agent Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: Arial;
      margin: 0;
      background: #f4f6f9;
      padding: 15px;
    }

    .topbar {
      font-size: 18px;
      margin-bottom: 15px;
      font-weight: bold;
    }

    .card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    button {
      padding: 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 8px;
      width: 100%;
      color: white;
      font-weight: bold;
    }

    .copy-btn { background: #007bff; }
    .green { background: #28a745; }
    .red { background: #dc3545; }
    .orange { background: #fd7e14; }
    .gray { background: #6c757d; }

    .timer {
      margin-top: 8px;
      font-size: 14px;
      color: #333;
    }

    table {
      width: 100%;
      background: white;
      border-collapse: collapse;
      margin-top: 10px;
      border-radius: 8px;
      overflow: hidden;
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }

    th {
      background: #f1f1f1;
    }

    .countdown {
      font-weight: bold;
      color: #dc3545;
    }

  </style>
</head>
<body>

<div class="topbar">
  Welcome, <span id="agentName"></span>
</div>

<div class="card" id="leadCard">
  Loading...
</div>

<div id="statusSection" style="display:none;">
  <button class="green" onclick="setStatus('interested')">Interested</button>
  <button class="red" onclick="setStatus('not_interested')">Not Interested</button>
  <button class="orange" onclick="setStatus('switch_off')">Switch Off / Not Received</button>
  <button class="gray" onclick="setStatus('invalid_number')">Invalid Number</button>
</div>

<h3>Interested Leads</h3>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Phone</th>
      <th>Status</th>
      <th>Follow Up</th>
      <th>Timer</th>
    </tr>
  </thead>
  <tbody id="interestedTable"></tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, query, where, getDocs, updateDoc, doc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC0Jf7YY9swFu_JAY-TeDfvlMCz1Iw23MU",
  authDomain: "leadgen-da6b8.firebaseapp.com",
  projectId: "leadgen-da6b8",
  storageBucket: "leadgen-da6b8.firebasestorage.app",
  messagingSenderId: "462081996744",
  appId: "1:462081996744:web:177127efe807c0f6b332fd"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentLead = null;
let agentUID = null;
let copyInterval = null;

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }

  agentUID = user.uid;
  document.getElementById("agentName").innerText = user.displayName || "Agent";

  loadNextLead();
  loadInterested();
});

async function loadNextLead() {
  const q = query(
    collection(db,"leads"),
    where("assignedTo","==",agentUID),
    where("status","==","pending")
  );

  const snap = await getDocs(q);

  if (snap.empty) {
    document.getElementById("leadCard").innerHTML = "No Pending Leads";
    return;
  }

  currentLead = snap.docs[0];
  const data = currentLead.data();

  document.getElementById("leadCard").innerHTML = `
    <h2>${data.name}</h2>
    <p>${data.phone}</p>
    <button class="copy-btn" onclick="copyNumber('${data.phone}')">Copy Number</button>
    <div class="timer" id="copyTimer"></div>
  `;

  document.getElementById("statusSection").style.display = "none";
}

window.copyNumber = async function(phone) {
  navigator.clipboard.writeText(phone);

  await updateDoc(doc(db,"leads",currentLead.id),{
    copyStartTime: serverTimestamp()
  });

  startCopyTimer();
  document.getElementById("statusSection").style.display = "block";
};

function startCopyTimer() {
  let seconds = 0;
  clearInterval(copyInterval);
  copyInterval = setInterval(()=>{
    seconds++;
    document.getElementById("copyTimer").innerText = "Timer: " + seconds + " sec";
  },1000);
}

window.setStatus = async function(status) {

  let updateData = { status: status };

  if(status==="interested"){
    updateData.interestedTime = serverTimestamp();
  }

  await updateDoc(doc(db,"leads",currentLead.id), updateData);

  clearInterval(copyInterval);
  loadNextLead();
};

function loadInterested() {
  const q = query(
    collection(db,"leads"),
    where("assignedTo","==",agentUID),
    where("status","in",["interested","link_sent"])
  );

  onSnapshot(q, snapshot=>{
    let html="";

    snapshot.forEach(docSnap=>{
      const data = docSnap.data();
      const id = docSnap.id;

      let baseTime = data.status==="interested"
        ? data.interestedTime?.toDate()
        : data.linkSentTime?.toDate();

      let remaining = "";

      if(baseTime){
        let diff = Math.floor((Date.now() - baseTime.getTime())/60000);
        remaining = 30 - diff;
      }

      html+=`
        <tr>
          <td>${data.name}</td>
          <td>${data.phone}</td>
          <td>${data.status}</td>
          <td>
            ${
              data.status==="interested"
              ? `<button class="green" onclick="sendLink('${id}')">Link Sent</button>`
              : `<button class="green" onclick="verifyLead('${id}')">Verified</button>`
            }
          </td>
          <td class="countdown">
            ${remaining>0 ? remaining+" min left" : "Time Over"}
          </td>
        </tr>
      `;
    });

    document.getElementById("interestedTable").innerHTML = html;
  });
}

window.sendLink = async function(id){
  await updateDoc(doc(db,"leads",id),{
    status:"link_sent",
    linkSentTime: serverTimestamp()
  });
};

window.verifyLead = async function(id){
  await updateDoc(doc(db,"leads",id),{
    status:"fully_verified",
    verifiedTime: serverTimestamp()
  });
};
</script>

</body>
</html>
